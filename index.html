<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NoppoBoard | Premium Collaboration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        :root {
            --n-bg: #fdfdfe;
            --n-main: #020617;
            --n-accent: #3b82f6;
            --n-border: rgba(15, 23, 42, 0.05);
            --n-glass: rgba(255, 255, 255, 0.7);
        }

        body { 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            background-color: var(--n-bg); 
            color: #0f172a;
            letter-spacing: -0.01em;
            word-break: break-word;
        }

        [v-cloak] { display: none; }

        /* Noppo Style Blur */
        .glass-header {
            background: var(--n-glass);
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--n-border);
        }

        /* Minimal Card */
        .n-card-premium {
            background: #ffffff;
            border: 1px solid var(--n-border);
            border-radius: 28px;
            transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .n-card-premium:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 48px -12px rgba(0, 0, 0, 0.04);
            border-color: rgba(15, 23, 42, 0.12);
        }

        /* Input Aesthetics */
        .n-input-field {
            background: #f8fafc;
            border: 1px solid transparent;
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .n-input-field:focus {
            background: #ffffff;
            border-color: var(--n-main);
            box-shadow: 0 0 0 4px rgba(2, 6, 23, 0.03);
            outline: none;
        }

        /* Buttons */
        .btn-n-black {
            background: var(--n-main);
            color: white;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .btn-n-black:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        /* Tabs UI */
        .tab-btn {
            position: relative;
            padding-bottom: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            color: #94a3b8;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            transition: color 0.3s;
        }
        .tab-btn.active {
            color: var(--n-main);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--n-main);
            border-radius: 2px;
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.8s cubic-bezier(0.2, 1, 0.3, 1) forwards;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-slate-200 antialiased">
    <div id="app" v-cloak>
        <!-- Loader -->
        <div v-if="loading" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
            <div class="flex flex-col items-center gap-6">
                <div class="relative w-10 h-10">
                    <div class="absolute inset-0 border-2 border-slate-50 rounded-full"></div>
                    <div class="absolute inset-0 border-t-2 border-slate-900 rounded-full animate-spin"></div>
                </div>
                <div class="text-[9px] font-black tracking-[0.4em] text-slate-300 uppercase">Synchronizing</div>
            </div>
        </div>

        <!-- Global Navigation -->
        <header class="sticky top-0 z-50 glass-header">
            <div class="max-w-[1200px] mx-auto px-6 h-16 flex items-center justify-between">
                <div @click="goHome" class="flex items-center gap-3 cursor-pointer group">
                    <div class="w-8 h-8 bg-slate-950 rounded-xl flex items-center justify-center text-white transition-transform group-hover:scale-105">
                        <i class="fas fa-box-archive text-xs"></i>
                    </div>
                    <h1 class="text-lg font-bold tracking-tighter text-slate-950">NoppoBoard</h1>
                </div>

                <div v-if="user" class="flex items-center gap-5">
                    <div class="hidden sm:flex items-center gap-1 bg-slate-100 p-1 rounded-xl">
                        <button @click="openModal('create')" class="px-3 py-1.5 text-[10px] font-bold text-slate-500 hover:bg-white hover:text-slate-900 rounded-lg transition">Êñ∞Ë¶è‰ΩúÊàê</button>
                        <button @click="openModal('join')" class="px-3 py-1.5 text-[10px] font-bold text-slate-500 hover:bg-white hover:text-slate-900 rounded-lg transition">ÂèÇÂä†</button>
                    </div>
                    <div class="h-6 w-[1px] bg-slate-200 mx-1"></div>
                    <div class="flex items-center gap-3">
                        <img :src="user.photoURL" class="w-8 h-8 rounded-full ring-2 ring-white shadow-sm">
                        <button @click="logout" class="p-2 text-slate-300 hover:text-red-500 transition"><i class="fas fa-power-off text-xs"></i></button>
                    </div>
                </div>
                <button v-else @click="login" class="btn-n-black px-6 py-2 text-xs">Login with NoppoAuth</button>
            </div>
        </header>

        <main class="max-w-[1200px] mx-auto px-6 py-12 md:py-20">
            
            <!-- Hero (Not Logged In) -->
            <section v-if="!user && !loading" class="text-center animate-slide-in py-10">
                <div class="inline-flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full mb-8">
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                    <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">Premium Learning Tool</span>
                </div>
                <h2 class="text-5xl md:text-7xl font-bold tracking-tighter text-slate-950 mb-8 leading-[1]">
                    ÊÉÖÂ†±„ÇíÊï¥ÁêÜ„Åó„ÄÅ<br>Áõ¥ÊÑü„ÅßÁπã„Åí„Çã„ÄÇ
                </h2>
                <p class="text-slate-400 text-base md:text-lg max-w-xl mx-auto mb-12 font-medium">
                    NoppoBoard„ÅØ„ÄÅÂ≠¶Áøí‰ΩìÈ®ì„Çí„Ç¢„ÉÉ„Éó„Éá„Éº„Éà„Åô„Çã„Åü„ÇÅ„Å´Ë®≠Ë®à„Åï„Çå„Åü<br>„Éü„Éã„Éû„É´„Åß„Éë„ÉØ„Éï„É´„Å™„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Åß„Åô„ÄÇ
                </p>
                <button @click="login" class="btn-n-black px-12 py-4 shadow-2xl shadow-slate-100">
                    NoppoAuth„ÅßË™çË®º„Åô„Çã
                </button>
            </section>

            <!-- Dashboard -->
            <section v-if="user && view === 'home'" class="animate-slide-in">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-16 gap-6">
                    <div>
                        <h2 class="text-4xl font-bold tracking-tighter mb-2">My Workspace</h2>
                        <p class="text-sm text-slate-400 font-medium">ÂèÇÂä†‰∏≠„ÅÆ„Éú„Éº„Éâ: {{ boards.length }}‰ª∂</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-xs"></i>
                            <input type="text" placeholder="Search boards..." class="n-input-field pl-10 pr-4 py-2.5 text-xs w-full md:w-64">
                        </div>
                    </div>
                </div>

                <div v-if="boards.length === 0" class="py-40 text-center border-2 border-dashed border-slate-100 rounded-[40px] bg-white/50">
                    <div class="w-16 h-16 bg-white border border-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                        <i class="fas fa-plus text-slate-200 text-xl"></i>
                    </div>
                    <p class="text-slate-400 font-bold tracking-tight">Êñ∞„Åó„ÅÑ„Éú„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶Âßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div v-for="b in boards" :key="b.id" @click="enterBoard(b)" class="n-card-premium group cursor-pointer overflow-hidden p-8 flex flex-col justify-between h-72">
                        <div>
                            <div class="flex justify-between items-start mb-6">
                                <span class="text-[9px] font-black tracking-[0.2em] text-slate-200 uppercase">{{ b.code }}</span>
                                <div class="w-8 h-8 rounded-xl bg-slate-50 flex items-center justify-center group-hover:bg-slate-900 group-hover:text-white transition-all">
                                    <i class="fas fa-arrow-right text-[10px]"></i>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold tracking-tight mb-2 group-hover:text-slate-900">{{ b.name }}</h3>
                            <p class="text-xs text-slate-400 line-clamp-2 leading-relaxed">{{ b.description || 'No description provided.' }}</p>
                        </div>
                        <div class="flex items-center gap-2 pt-6 border-t border-slate-50 mt-auto">
                            <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">{{ (b.members || []).length }} Members</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Board Detail -->
            <section v-if="user && view === 'board' && currentBoard" class="animate-slide-in">
                <div class="mb-12 flex items-center gap-4">
                    <button @click="goHome" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition">
                        <i class="fas fa-chevron-left text-xs text-slate-400"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold tracking-tighter">{{ currentBoard.name }}</h2>
                        <p class="text-[10px] text-slate-300 font-black uppercase tracking-widest">{{ currentBoard.code }}</p>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-10 border-b border-slate-100 mb-12 overflow-x-auto no-scrollbar">
                    <button v-for="tab in ['stream', 'tasks', 'materials']" 
                            @click="activeTab = tab" 
                            :class="{active: activeTab === tab}"
                            class="tab-btn">
                        {{ tab === 'stream' ? 'Stream' : tab === 'tasks' ? 'Tasks' : 'Files' }}
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                    <div class="lg:col-span-8 space-y-10">
                        <!-- Creator -->
                        <div class="n-card-premium p-6">
                            <div class="flex gap-4">
                                <img :src="user.photoURL" class="w-10 h-10 rounded-full">
                                <div class="flex-1">
                                    <textarea v-model="newPostText" 
                                              placeholder="Share something with your team..."
                                              class="w-full text-sm font-medium border-none focus:ring-0 resize-none py-2 min-h-[80px]" rows="3"></textarea>
                                    <div class="flex items-center justify-between pt-4 border-t border-slate-50 mt-4">
                                        <button class="w-8 h-8 flex items-center justify-center rounded-xl hover:bg-slate-50 text-slate-300 transition">
                                            <i class="fas fa-paperclip text-xs"></i>
                                        </button>
                                        <button @click="addPost" :disabled="!newPostText.trim()" 
                                                class="btn-n-black px-6 py-2.5 text-[10px] uppercase tracking-widest disabled:opacity-20">Post</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Posts -->
                        <div class="space-y-8">
                            <div v-for="post in filteredPosts" :key="post.id" class="n-card-premium p-10 group relative">
                                <div class="flex items-start justify-between mb-8">
                                    <div class="flex items-center gap-4">
                                        <img :src="post.avatar" class="w-10 h-10 rounded-full bg-slate-50 shadow-sm">
                                        <div>
                                            <h4 class="text-sm font-bold text-slate-900">{{ post.author }}</h4>
                                            <p class="text-[9px] text-slate-300 font-black uppercase tracking-widest">
                                                {{ post.createdAt ? formatTime(post.createdAt) : 'Sending' }}
                                            </p>
                                        </div>
                                    </div>
                                    <div v-if="post.type && post.type !== 'announcement'" 
                                          class="px-2 py-0.5 bg-slate-100 rounded text-[8px] font-black uppercase tracking-widest text-slate-400">
                                        {{ post.type }}
                                    </div>
                                </div>
                                <p class="text-[15px] text-slate-600 whitespace-pre-wrap leading-relaxed mb-8 pl-1">{{ post.content }}</p>
                                
                                <div class="flex items-center gap-3 pt-6 border-t border-slate-50">
                                    <button v-for="(count, emoji) in post.reactions" :key="emoji" @click="addReaction(post.id, emoji)" 
                                            class="px-3 py-1.5 bg-slate-50 rounded-xl text-[10px] flex items-center gap-2 hover:bg-slate-100 transition">
                                        <span>{{ emoji }}</span>
                                        <span class="font-bold text-slate-900">{{ count }}</span>
                                    </button>
                                    <div class="flex gap-1 ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button v-for="e in ['üëç','üí°','üî•']" :key="e" @click="addReaction(post.id, e)" 
                                                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-50 transition text-xs">
                                            {{ e }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="lg:col-span-4 space-y-8">
                        <div class="n-card-premium p-8">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-300 mb-6">Board Access</h4>
                            <div class="bg-slate-950 p-6 rounded-[24px] text-center shadow-2xl shadow-slate-100">
                                <span class="text-2xl font-bold text-white tracking-[0.4em] font-mono">{{ currentBoard.code }}</span>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-6 text-center leading-relaxed">„Åì„ÅÆ„Ç≥„Éº„Éâ„ÇíÂÖ±Êúâ„Åó„Å¶„É°„É≥„Éê„Éº„ÇíÊãõÂæÖ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Modals -->
        <div v-if="modal.show" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
            <div @click="modal.show = false" class="absolute inset-0 bg-white/60 backdrop-blur-xl"></div>
            <div class="bg-white rounded-[40px] w-full max-w-lg relative p-12 shadow-[0_40px_100px_-20px_rgba(0,0,0,0.1)] border border-slate-100 animate-slide-in">
                <div class="mb-10">
                    <h3 class="text-3xl font-bold tracking-tighter text-slate-900 mb-2">
                        {{ modal.type === 'create' ? 'Create Space' : 'Join Board' }}
                    </h3>
                    <p class="text-xs text-slate-400 font-medium">
                        {{ modal.type === 'create' ? 'Êñ∞„Åó„ÅÑÂÖ±Âêå‰ΩúÊ•≠„Çπ„Éö„Éº„Çπ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ' : 'ÊãõÂæÖ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶ÂèÇÂä†„Åó„Åæ„Åô„ÄÇ' }}
                    </p>
                </div>

                <div v-if="modal.type === 'create'" class="space-y-4">
                    <input v-model="modal.name" type="text" placeholder="Board Name" class="n-input-field w-full px-6 py-4 text-sm">
                    <textarea v-model="modal.description" placeholder="Short Description..." class="n-input-field w-full px-6 py-4 text-sm h-28 resize-none"></textarea>
                </div>
                
                <div v-else>
                    <input v-model="modal.code" type="text" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" 
                           class="n-input-field w-full px-6 py-6 text-center font-mono text-4xl uppercase tracking-[0.4em] text-slate-950">
                </div>

                <div class="flex flex-col gap-4 mt-10">
                    <button @click="handleModalAction" class="btn-n-black py-4 text-xs font-black uppercase tracking-widest">
                        {{ modal.type === 'create' ? 'Create Now' : 'Join Board' }}
                    </button>
                    <button @click="modal.show = false" class="py-3 text-[10px] font-black text-slate-300 uppercase tracking-widest hover:text-slate-900 transition">Cancel</button>
                </div>
            </div>
        </div>

        <footer class="py-20 text-center border-t border-slate-50 mt-20">
            <p class="text-[9px] font-black uppercase tracking-[0.6em] text-slate-200">NoppoBoard &copy; 2026 Crafted by NoppoStudio</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, serverTimestamp, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { createApp, ref, onMounted, computed } from "https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js";

        // „Éû„Éã„É•„Ç¢„É´Ë®òËºâ„ÅÆÂü∫Êú¨Ë®≠ÂÆö
        const AUTH_WORKER_URL = "https://noppo-auth.noppo5319.workers.dev";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2YXZhc3JkeGd1cWtpaWdjeGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTk5ODcsImV4cCI6MjA4Mjk5NTk4N30.CVq3lyRbxek7Ejs4tP5sN9-0JNEXSLtCsC2Pj-skFFQ";

        const firebaseConfig = {
            apiKey: "AIzaSyB2HcI-TwH88QDADp-Z5cUFRCsaVO2VMw0",
            authDomain: "portal-1767266387985.firebaseapp.com",
            projectId: "portal-1767266387985",
            storageBucket: "portal-1767266387985.firebasestorage.app",
            messagingSenderId: "931194072772",
            appId: "1:931194072772:web:05d7e925662ddd0f1d6391",
            measurementId: "G-4P3HJPWXHH"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'noppo-board-portal-v4';

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const view = ref('home');
                const activeTab = ref('stream');
                const boards = ref([]);
                const currentBoard = ref(null);
                const posts = ref([]);
                const newPostText = ref('');
                const modal = ref({ show: false, type: 'join', code: '', name: '', description: '' });

                let db, auth;

                const getPublicCol = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

                const initApp = async () => {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    onAuthStateChanged(auth, async (fbUser) => {
                        if (fbUser) {
                            await loadNoppoUser();
                        } else {
                            loading.value = false;
                        }
                    });

                    // ÂåøÂêçË™çË®º„Åß„Éô„Éº„Çπ„ÅÆAuthÁä∂ÊÖã„ÇíÁ¢∫Á´ã
                    try {
                        await signInAnonymously(auth);
                    } catch (e) { console.error("Firebase Auth Init Error:", e); }
                };

                // „Éû„Éã„É•„Ç¢„É´„ÅÆ„Äå„Çπ„ÉÜ„ÉÉ„Éó2Ôºö„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó„Åô„Çã„Äç„ÇíÂÆüË£Ö
                async function loadNoppoUser() {
                    const params = new URLSearchParams(window.location.search);
                    const ticket = params.get('ticket');

                    try {
                        const url = ticket 
                            ? `${AUTH_WORKER_URL}/auth/v1/user?ticket=${ticket}`
                            : `${AUTH_WORKER_URL}/auth/v1/user`;

                        const res = await fetch(url, { headers: { "apikey": SUPABASE_KEY } });

                        if (res.ok) {
                            const data = await res.json();
                            user.value = {
                                uid: auth.currentUser.uid,
                                displayName: data.user_metadata.display_name,
                                photoURL: data.user_metadata.avatar_url,
                                email: data.email
                            };
                            
                            if (ticket) {
                                const cleanUrl = window.location.origin + window.location.pathname;
                                window.history.replaceState({}, document.title, cleanUrl);
                            }
                            syncBoards();
                        } else {
                            // „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁ¢∫Ë™ç
                            const saved = localStorage.getItem('noppo_user_cache');
                            if (saved) {
                                user.value = JSON.parse(saved);
                                syncBoards();
                            }
                        }
                    } catch (e) {
                        console.error("„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
                    } finally {
                        loading.value = false;
                    }
                }

                const syncBoards = () => {
                    if (!user.value) return;
                    localStorage.setItem('noppo_user_cache', JSON.stringify(user.value));
                    onSnapshot(getPublicCol('boards'), (snap) => {
                        boards.value = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                            .filter(b => (b.members || []).includes(user.value.displayName) || b.owner === user.value.displayName);
                    });
                };

                const createBoard = async () => {
                    if (!modal.value.name || !user.value) return;
                    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await addDoc(getPublicCol('boards'), {
                        name: modal.value.name,
                        description: modal.value.description,
                        code: code,
                        owner: user.value.displayName,
                        members: [user.value.displayName],
                        createdAt: serverTimestamp()
                    });
                    modal.value.show = false;
                };

                const joinBoard = async () => {
                    const inputCode = modal.value.code.toUpperCase().trim();
                    if (!inputCode || !user.value) return;
                    onSnapshot(getPublicCol('boards'), async (snap) => {
                        const target = snap.docs.find(d => d.data().code === inputCode);
                        if (target) {
                            const boardRef = doc(db, 'artifacts', appId, 'public', 'data', 'boards', target.id);
                            await updateDoc(boardRef, { members: arrayUnion(user.value.displayName) });
                            modal.value.show = false;
                            enterBoard({ id: target.id, ...target.data() });
                        }
                    }, { once: true });
                };

                const enterBoard = (board) => {
                    currentBoard.value = board;
                    view.value = 'board';
                    activeTab.value = 'stream';
                    const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'boards', board.id, 'posts');
                    onSnapshot(postsCol, (snap) => {
                        posts.value = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                            .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    });
                };

                const addPost = async () => {
                    if (!newPostText.value.trim() || !user.value) return;
                    const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'boards', currentBoard.value.id, 'posts');
                    await addDoc(postsCol, {
                        author: user.value.displayName,
                        avatar: user.value.photoURL,
                        content: newPostText.value,
                        type: activeTab.value === 'stream' ? 'announcement' : activeTab.value,
                        reactions: {},
                        createdAt: serverTimestamp()
                    });
                    newPostText.value = '';
                };

                const addReaction = async (postId, emoji) => {
                    const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'boards', currentBoard.value.id, 'posts', postId);
                    await updateDoc(postRef, { [`reactions.${emoji}`]: increment(1) });
                };

                const filteredPosts = computed(() => {
                    if (activeTab.value === 'stream') return posts.value;
                    return posts.value.filter(p => p.type === activeTab.value);
                });

                const formatTime = (ts) => {
                    if (!ts) return '';
                    const d = ts.toDate();
                    return d.toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                };

                onMounted(() => initApp());

                return {
                    user, loading, view, activeTab, boards, currentBoard, posts, newPostText, modal,
                    filteredPosts, formatTime,
                    login: () => {
                        const currentUrl = encodeURIComponent(window.location.href);
                        window.location.href = `${AUTH_WORKER_URL}?redirect=${currentUrl}`;
                    },
                    logout: async () => {
                        localStorage.removeItem('noppo_user_cache');
                        const currentUrl = encodeURIComponent(window.location.href);
                        window.location.href = `${AUTH_WORKER_URL}/logout?redirect=${currentUrl}`;
                    },
                    goHome: () => { view.value = 'home'; currentBoard.value = null; },
                    enterBoard, addPost, addReaction,
                    openModal: (type) => modal.value = { show: true, type, code: '', name: '', description: '' },
                    handleModalAction: () => modal.value.type === 'create' ? createBoard() : joinBoard()
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
